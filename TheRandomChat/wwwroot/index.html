<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TheRandomChat</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 24px;
            background: #0f172a;
            color: #e2e8f0;
        }

        .card {
            max-width: 720px;
            margin: 0 auto;
            background: #111827;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .3);
        }

        .row {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        input,
        button {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0b1220;
            color: #e2e8f0;
        }

        button {
            background: #2563eb;
            border: none;
            cursor: pointer;
        }

        button:disabled {
            background: #334155;
            cursor: not-allowed;
        }

        #messages {
            background: #0b1220;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            height: 300px;
            overflow: auto;
        }

        .msg {
            margin: 6px 0;
            padding: 8px 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .me {
            background: #1e293b;
            margin-left: auto;
        }

        .peer {
            background: #0ea5e9;
            color: #0b1220;
            margin-right: auto;
        }

        .muted {
            color: #94a3b8;
            font-size: 12px;
        }

        .error {
            color: #fca5a5;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
</head>

<body>
    <div class="card">
        <h2>Random Chat</h2>
        <div class="row">
            <input id="username" placeholder="ŸÜÿßŸÖ ⁄©ÿßÿ±ÿ®ÿ±€å" autocomplete="off" />
            <button id="btnRegister">ÿØÿ±€åÿßŸÅÿ™ ÿ™Ÿà⁄©ŸÜ Ÿà ÿßÿ™ÿµÿßŸÑ</button>
        </div>
        <div class="muted" id="status">Disconnected</div>
        <div id="messages"></div>
        <div class="row">
            <input id="message" placeholder="Ÿæ€åÿßŸÖ ÿ®ŸÜŸà€åÿ≥..." autocomplete="off" disabled />
            <button id="btnSend" disabled>ÿßÿ±ÿ≥ÿßŸÑ</button>
        </div>
        <div id="error" class="error"></div>
    </div>

    <script>
        (() => {
            const els = {
                username: document.getElementById('username'),
                btnRegister: document.getElementById('btnRegister'),
                status: document.getElementById('status'),
                messages: document.getElementById('messages'),
                message: document.getElementById('message'),
                btnSend: document.getElementById('btnSend'),
                error: document.getElementById('error'),
            };

            let token = localStorage.getItem('rc_token');
            let connection = null;

            const setStatus = (text) => els.status.textContent = text;
            const setError = (text) => els.error.textContent = text || '';
            const appendMsg = (text, who) => {
                const div = document.createElement('div');
                div.className = 'msg ' + (who === 'me' ? 'me' : 'peer');
                div.textContent = text;
                els.messages.appendChild(div);
                els.messages.scrollTop = els.messages.scrollHeight;
            };

            async function registerAndConnect() {
                setError('');
                const username = (els.username.value || '').trim();
                if (!username) {
                    setError('ŸÜÿßŸÖ ⁄©ÿßÿ±ÿ®ÿ±€å ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                    return;
                }

                try {
                    setStatus('Registering...');
                    const baseUrl = '~';
                    const res = await fetch(`${baseUrl}/api/RegisterName/RegisterName?username=${encodeURIComponent(username)}`, {
                        method: 'POST'
                    });

                    if (!res.ok) {
                        const txt = await res.text();
                        throw new Error(txt || 'ÿ´ÿ®ÿ™ ŸÜÿßŸÖ ŸÜÿßŸÖŸàŸÅŸÇ ÿ®ŸàÿØ');
                    }

                    const data = await res.json();
                    token = data.token || data.Token;
                    if (!token) throw new Error('ÿ™Ÿà⁄©ŸÜ ÿØÿ±€åÿßŸÅÿ™ ŸÜÿ¥ÿØ');

                    localStorage.setItem('rc_token', token);

                    setStatus('Connecting to hub...');
                    connection = new signalR.HubConnectionBuilder()
                        .withUrl('/ChatHub', {
                            accessTokenFactory: () => token,
                            transport: signalR.HttpTransportType.WebSockets,
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                        .withAutomaticReconnect()
                        .build();

                    // üìå ÿØÿ±€åÿßŸÅÿ™ Ÿæ€åÿßŸÖ
                    connection.on('ReceiveMessage', (messages) => {
                        try {
                            if (!messages) return;

                            // ÿß⁄Øÿ± ŸÑ€åÿ≥ÿ™ ÿ®ŸàÿØ ‚Üí ÿ¢ÿÆÿ±€åŸÜ Ÿæ€åÿßŸÖ
                            if (Array.isArray(messages) && messages.length > 0) {
                                const lastMessage = messages[messages.length - 1];
                                if (!lastMessage || !lastMessage.trim()) return;

                                if (lastMessage.startsWith(`${els.username.value}:`)) {
                                    appendMsg(lastMessage, 'me');
                                } else if (lastMessage.includes(':')) {
                                    appendMsg(lastMessage, 'peer');
                                } else {
                                    appendMsg(lastMessage, 'peer'); // fallback string
                                }
                            }
                            // ÿß⁄Øÿ± ŸÅŸÇÿ∑ string ÿÆÿßŸÖ ÿ®ŸàÿØ
                            else if (typeof messages === "string") {
                                if (!messages.trim()) return;
                                appendMsg(messages, 'peer'); // fallback string
                            }
                        } catch (e) {
                            console.error('Receive message error:', e);
                        }
                    });

                    connection.onreconnecting(() => setStatus('Reconnecting...'));
                    connection.onreconnected(() => setStatus('Connected'));
                    connection.onclose(() => setStatus('Disconnected'));

                    await connection.start();
                    setStatus('Connected');
                    els.message.disabled = false;
                    els.btnSend.disabled = false;
                } catch (err) {
                    setError(err.message || String(err));
                    setStatus('Disconnected');
                }
            }

            async function sendMessage() {
                setError('');
                const text = (els.message.value || '').trim();
                if (!text || !connection) return;
                try {
                    els.message.value = '';
                    console.log('Sending message:', text);
                    await connection.invoke('SendMessage', text);
                    console.log('Message sent successfully');
                } catch (err) {
                    console.error('Send message error:', err);
                    setError(err.message || String(err));
                }
            }

            els.btnRegister.addEventListener('click', registerAndConnect);
            els.btnSend.addEventListener('click', sendMessage);
            els.message.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        })();
    </script>
</body>

</html>