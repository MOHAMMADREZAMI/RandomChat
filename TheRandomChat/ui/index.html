<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RandomChat UI</title>
    <style>
        body {
            margin: 0;
            font-family: Segoe UI, Roboto, Arial, sans-serif;
            background: #0f172a;
            color: #0f172a
        }

        .wrap {
            max-width: 880px;
            margin: 0 auto;
            padding: 20px
        }

        .card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, .15);
            overflow: hidden
        }

        .head {
            padding: 16px 18px;
            border-bottom: 1px solid #eef2f7;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .title {
            font-weight: 700
        }

        .body {
            padding: 16px
        }

        .row {
            display: flex;
            gap: 10px
        }

        input[type=text] {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 10px
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            background: #111827;
            color: #fff;
            cursor: pointer
        }

        button.secondary {
            background: #fff;
            color: #111;
            border: 1px solid #d1d5db
        }

        .error {
            color: #ef4444;
            margin-top: 10px;
            display: none
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px
        }

        .messages {
            height: 52vh;
            overflow: auto;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px
        }

        .msg {
            display: flex;
            gap: 8px;
            margin: 8px 0
        }

        .msg.own {
            flex-direction: row-reverse
        }

        .bubble {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px 12px;
            max-width: 70%
        }

        .own .bubble {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb
        }

        .muted {
            opacity: .7;
            font-size: 12px
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card" style="margin-bottom:16px">
            <div class="head">
                <div class="title">اتصال</div>
            </div>
            <div class="body grid">
                <div class="row">
                    <input id="server" type="text" value="http://localhost:5145" placeholder="آدرس سرور" />
                    <button id="save">ذخیره</button>
                </div>
                <form id="login" class="row">
                    <input id="username" type="text" placeholder="نام کاربری" required />
                    <button type="submit">شروع</button>
                    <button id="logout" type="button" class="secondary">خروج</button>
                </form>
                <div id="error" class="error"></div>
                <details>
                    <summary>نمایش اطلاعات دیباگ</summary>
                    <div id="debug"
                        style="font-family:monospace;white-space:pre-wrap;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:8px">
                    </div>
                </details>
            </div>
        </div>

        <div class="card">
            <div class="head">
                <div class="title">چت</div>
                <div id="status" class="muted">وضعیت: قطع</div>
            </div>
            <div class="body grid">
                <div id="messages" class="messages"></div>
                <form id="composer" class="row">
                    <input id="text" type="text" placeholder="پیام..." disabled />
                    <button id="send" type="submit" disabled>ارسال</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <script>
        let hub = null;
        let token = localStorage.getItem('rc_token') || '';
        let currentToken = token;              // آخرین توکن ذخیره‌شده
        let appliedToken = null;               // توکن به‌کاررفته هنگام Handshake فعلی
        let reconnectInProgress = false;       // جلوگیری از حلقه reconnect
        let lastHubBase = null;                // آدرس Hub بدون query
        let name = localStorage.getItem('rc_user') || '';

        const serverInput = document.getElementById('server');
        const saveBtn = document.getElementById('save');
        const loginForm = document.getElementById('login');
        const logoutBtn = document.getElementById('logout');
        const usernameInput = document.getElementById('username');
        const errorEl = document.getElementById('error');
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const composer = document.getElementById('composer');
        const textInput = document.getElementById('text');
        const sendBtn = document.getElementById('send');

        // init defaults
        serverInput.value = localStorage.getItem('rc_server') || 'http://localhost:5145';
        if (name) usernameInput.value = name;

        saveBtn.addEventListener('click', () => {
            localStorage.setItem('rc_server', serverInput.value.trim());
            showMsg('تنظیمات ذخیره شد.');
            updateDebug();
        });

        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            clearError();
            const server = serverInput.value.trim();
            name = usernameInput.value.trim();
            if (!server || !name) return showError('آدرس سرور و نام کاربری لازم است');

            try {
                const res = await axios.post(`${server}/api/RegisterName/Name`, null, { params: { username: name } });
                let data = res?.data;
                if (typeof data === 'string') { try { data = JSON.parse(data); } catch { } }
                const receivedToken = data?.Authorization ?? data?.authorization ?? data?.token;
                const connectServer = data?.url || server;
                if (!receivedToken) return showError('توکن از سرور دریافت نشد');

                token = receivedToken;
                currentToken = token;
                localStorage.setItem('rc_server', connectServer);
                localStorage.setItem('rc_user', name);
                localStorage.setItem('rc_token', token);
                updateDebug();
                await connect(connectServer);
            } catch (err) {
                if (err.response?.status === 409) showError('نام کاربری تکراری است');
                else showError('خطا در برقراری ارتباط با سرور');
            }
        });

        logoutBtn.addEventListener('click', () => {
            if (hub) hub.stop();
            localStorage.removeItem('rc_token');
            localStorage.removeItem('rc_user');
            token = '';
            currentToken = '';
            name = '';
            usernameInput.value = '';
            setStatus('قطع');
            toggleComposer(false);
        });

        composer.addEventListener('submit', async e => {
            e.preventDefault();
            const text = textInput.value.trim();
            if (!text || !hub) return;
            try {
                await hub.invoke('SendMessage', text);
                textInput.value = '';
            } catch (err) {
                console.error(err);
                // اگر توکن جاری با توکن به‌کاررفته روی اتصال فرق دارد، یک reconnect سریع انجام بده و یک‌بار دیگر تلاش کن
                if (appliedToken !== currentToken) {
                    try {
                        if (hub) await hub.stop();
                        hub = new signalR.HubConnectionBuilder()
                            .withUrl(lastHubBase, { accessTokenFactory: () => currentToken })
                            .withAutomaticReconnect()
                            .build();
                        hub.on('RecevieMessage', list => render(list || []));
                        await hub.start();
                        appliedToken = currentToken;
                        await hub.invoke('SendMessage', text);
                        textInput.value = '';
                    } catch (e2) { console.error(e2); }
                }
            }
        });

        async function connect(server) {
            if (!currentToken) { return showError('توکن موجود نیست'); }
            if (hub) try { await hub.stop(); } catch { }

            const base = server.replace(/\/+$/, '');
            lastHubBase = base.endsWith('/ChatHub') ? base : `${base}/ChatHub`;

            // فقط از accessTokenFactory استفاده می‌کنیم تا همیشه توکن جاری ارسال شود
            hub = new signalR.HubConnectionBuilder()
                .withUrl(lastHubBase, { accessTokenFactory: () => currentToken })
                .withAutomaticReconnect()
                .build();

            hub.onclose(() => { setStatus('قطع'); reconnectInProgress = false; });
            hub.onreconnecting(() => setStatus('در حال اتصال...'));
            hub.onreconnected(() => { setStatus('متصل'); appliedToken = currentToken; reconnectInProgress = false; });

            hub.on('ReceiveToken', (t) => {
                if (!t) return;
                // مانند سناریوی SendMessage: فقط توکن را ذخیره کن؛ reconnect انجام نده
                currentToken = t;
                localStorage.setItem('rc_token', currentToken);
                updateDebug();
            });


            hub.on('RecevieMessage', list => render(list || []));

            try {
                await hub.start();
                setStatus('متصل');
                toggleComposer(true);
                appliedToken = currentToken; // توکن handshake فعلی
                console.log('[UI] SignalR connected');
            } catch (err) {
                console.error(err);
                showError('اتصال SignalR ناموفق بود');
            }
        }

        function render(items) {
            messagesEl.innerHTML = '';
            for (const m of items) {
                const div = document.createElement('div');
                div.className = 'msg';
                const idx = m.indexOf(' : ');
                const author = idx === -1 ? '' : m.substring(0, idx);
                const content = idx === -1 ? m : m.substring(idx + 3);
                if (author && author === name) div.classList.add('own');
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = content;
                div.appendChild(bubble);
                messagesEl.appendChild(div);
            }
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function toggleComposer(enabled) { textInput.disabled = !enabled; sendBtn.disabled = !enabled; }
        function setStatus(text) { statusEl.textContent = 'وضعیت: ' + text; }
        function showError(msg) { errorEl.textContent = msg; errorEl.style.display = 'block'; }
        function clearError() { errorEl.textContent = ''; errorEl.style.display = 'none'; }
        function showMsg(msg) { console.log(msg); }

        function decodeJwtPayload(tk) {
            try {
                const parts = tk.split('.');
                if (parts.length !== 3) return null;
                const json = atob(parts[1].replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(json);
            } catch { return null; }
        }

        function updateDebug() {
            const dbg = document.getElementById('debug');
            if (!dbg) return;
            const srv = serverInput.value.trim();
            const tk = localStorage.getItem('rc_token') || '';
            const parsed = tk ? decodeJwtPayload(tk) : null;
            const nameClaim = parsed?.name || parsed?.unique_name || parsed?.sub || '';
            const exp = parsed?.exp ? new Date(parsed.exp * 1000).toLocaleString('fa-IR') : '';
            dbg.textContent = `server: ${srv}\nuser: ${name || ''}\ntoken: ${tk ? tk.substring(0, 20) + '...' : '(none)'}\nclaims.name: ${nameClaim}\nexp: ${exp}`;
        }

        updateDebug();
    </script>
</body>

</html>